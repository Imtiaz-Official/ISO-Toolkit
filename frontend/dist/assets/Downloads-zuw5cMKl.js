import{r,j as e}from"./index-TDQAEirs.js";import{d as b}from"./api-CP8hbXFM.js";const w="ws://127.0.0.1:8000/api/ws/downloads";function N(t){const[f,o]=r.useState(!1),[g,h]=r.useState(null),n=r.useRef(null),c=r.useRef(new Map),m=r.useRef(null),x=r.useRef(t);r.useEffect(()=>{x.current=t},[t]);const i=r.useCallback(()=>{var d;if(((d=n.current)==null?void 0:d.readyState)!==WebSocket.OPEN)try{const s=new WebSocket(w);n.current=s,s.onopen=()=>{o(!0)},s.onmessage=a=>{try{const l=JSON.parse(a.data);if(l.type==="connected")h(l.client_id||null);else if(l.type==="download_progress"&&l.download_id!==void 0){const j={type:"download_progress",download_id:l.download_id,data:l.data};c.current.set(l.download_id,l.data),x.current&&x.current(j)}}catch(l){console.error("Error parsing WebSocket message:",l)}},s.onclose=()=>{o(!1),h(null),m.current=setTimeout(()=>{i()},3e3)},s.onerror=a=>{console.error("WebSocket error:",a)}}catch(s){console.error("Failed to create WebSocket connection:",s)}},[]),u=r.useCallback(()=>{m.current&&clearTimeout(m.current),n.current&&(n.current.close(),n.current=null),o(!1),h(null)},[]),p=r.useCallback(d=>{var s;((s=n.current)==null?void 0:s.readyState)===WebSocket.OPEN&&n.current.send(JSON.stringify({type:"subscribe",download_id:d}))},[]),y=r.useCallback(d=>{var s;((s=n.current)==null?void 0:s.readyState)===WebSocket.OPEN&&n.current.send(JSON.stringify({type:"unsubscribe",download_id:d}))},[]),v=r.useCallback(d=>{var s;((s=n.current)==null?void 0:s.readyState)===WebSocket.OPEN&&n.current.send(JSON.stringify(d))},[]);return r.useEffect(()=>(i(),()=>{u()}),[i,u]),{connected:f,clientId:g,progressUpdates:c.current,subscribeToDownload:p,unsubscribeFromDownload:y,send:v,connect:i,disconnect:u}}function R(){const[t,f]=r.useState([]),[o,g]=r.useState(!0),h=r.useRef(new Map),{connected:n}=N(s=>{f(a=>a.map(l=>l.id===s.download_id?{...l,state:s.data.state,progress:s.data.progress,downloaded_bytes:s.data.downloaded_bytes,total_bytes:s.data.total_bytes,downloaded_formatted:s.data.downloaded_formatted,total_formatted:s.data.total_formatted,speed:s.data.speed,speed_formatted:s.data.speed_formatted,eta:s.data.eta,eta_formatted:s.data.eta_formatted,error_message:s.data.error_message??null,checksum_verified:s.data.checksum_verified??null}:l))}),c=r.useCallback(async()=>{try{const s=await b.getAll();f(s),s.forEach(a=>h.current.set(a.id,a))}catch(s){console.error("Failed to load downloads:",s)}finally{g(!1)}},[]);r.useEffect(()=>{c();const s=setInterval(c,2e3);return()=>clearInterval(s)},[c]);async function m(s){try{await b.pause(s),await c()}catch(a){console.error("Failed to pause download:",a)}}async function x(s){try{await b.resume(s),await c()}catch(a){console.error("Failed to resume download:",a)}}async function i(s){if(confirm("Are you sure you want to cancel this download?"))try{await b.cancel(s),await c()}catch(a){console.error("Failed to cancel download:",a)}}async function u(){if(confirm("Clear all completed, failed, and cancelled downloads?"))try{await b.clearCompleted(),await c()}catch(s){console.error("Failed to clear completed:",s)}}async function p(s){try{await b.delete(s),f(a=>a.filter(l=>l.id!==s))}catch(a){console.error("Failed to dismiss download:",a),await c()}}function y(s){switch(s){case"downloading":return"text-blue-600 bg-blue-50 dark:bg-blue-900/20";case"paused":return"text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20";case"completed":return"text-green-600 bg-green-50 dark:bg-green-900/20";case"failed":return"text-red-600 bg-red-50 dark:bg-red-900/20";case"cancelled":return"text-gray-600 bg-gray-50 dark:bg-gray-900/20";default:return"text-gray-600 bg-gray-50 dark:bg-gray-900/20"}}function v(s){switch(s){case"downloading":return"â¬‡ï¸";case"paused":return"â¸ï¸";case"completed":return"âœ…";case"failed":return"âŒ";case"cancelled":return"ðŸš«";default:return"â³"}}const d=t.filter(s=>s.state==="completed"||s.state==="failed"||s.state==="cancelled").length;return e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white",children:"Downloads"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-400 mt-1",children:n?e.jsx("span",{className:"text-green-600",children:"Connected - Real-time updates"}):e.jsx("span",{className:"text-yellow-600",children:"Connecting..."})})]}),d>0&&e.jsxs("button",{onClick:u,className:"btn btn-secondary text-sm sm:text-base w-full sm:w-auto",children:["Clear Completed (",d,")"]})]}),o&&e.jsx("div",{className:"flex items-center justify-center h-48 sm:h-64",children:e.jsxs("div",{className:"flex flex-col items-center space-y-3 sm:space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading downloads..."})]})}),!o&&t.length===0&&e.jsxs("div",{className:"text-center py-8 sm:py-12 px-4",children:[e.jsx("div",{className:"text-5xl sm:text-6xl mb-4",children:"ðŸ“¥"}),e.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white mb-2",children:"No Downloads Yet"}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-400 mb-4 sm:mb-6",children:"Start by browsing and downloading an OS"}),e.jsx("a",{href:"/browse",className:"btn btn-primary text-sm sm:text-base",children:"Browse ISOs"})]}),!o&&t.length>0&&e.jsx("div",{className:"space-y-3 sm:space-y-4",children:t.map(s=>e.jsx(k,{download:s,onPause:m,onResume:x,onCancel:i,onDismiss:p,getStateColor:y,getStateIcon:v},s.id))})]})}function k({download:t,onPause:f,onResume:o,onCancel:g,onDismiss:h,getStateColor:n,getStateIcon:c}){const m=t.state==="downloading",x=t.state==="paused",i=t.state==="completed",u=t.state==="failed",p=t.state==="cancelled";return e.jsxs("div",{className:"card p-3 sm:p-4 transition-all duration-300 hover:shadow-lg",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-0 mb-3 sm:mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 sm:space-x-3",children:[e.jsx("span",{className:"text-xl sm:text-2xl",children:t.os_icon||"ðŸ’¿"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold text-sm sm:text-lg text-gray-900 dark:text-white truncate",children:t.os_name}),e.jsxs("p",{className:"text-xs sm:text-sm text-gray-500 dark:text-gray-400",children:[t.os_version," - ",t.os_architecture]})]})]}),e.jsxs("span",{className:`px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${n(t.state)} self-start`,children:[c(t.state)," ",t.state.charAt(0).toUpperCase()+t.state.slice(1)]})]}),(m||x)&&t.total_bytes>0&&e.jsxs("div",{className:"mb-3 sm:mb-4",children:[e.jsxs("div",{className:"flex justify-between text-xs sm:text-sm mb-1",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[t.downloaded_formatted," / ",t.total_formatted]}),e.jsxs("span",{className:"font-medium text-gray-900 dark:text-white",children:[t.progress.toFixed(1),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-300 ease-out",style:{width:`${t.progress}%`}})}),e.jsxs("div",{className:"flex justify-between text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1",children:[e.jsx("span",{className:"font-medium",children:t.speed_formatted}),e.jsxs("span",{children:["ETA: ",t.eta_formatted]})]})]}),i&&e.jsxs("div",{className:"mb-3 sm:mb-4 p-2 sm:p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg animate-fade-in",children:[e.jsxs("div",{className:"flex items-center text-green-700 dark:text-green-400 text-xs sm:text-sm",children:[e.jsx("svg",{className:"w-4 h-4 sm:w-5 sm:h-5 mr-2 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{className:"break-all font-medium",children:"Download Complete!"})]}),e.jsxs("div",{className:"text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1 truncate flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 sm:w-4 sm:h-4 mr-2 flex-shrink-0 text-gray-500",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z",clipRule:"evenodd"})}),e.jsx("span",{className:"truncate",children:t.output_path})]}),t.checksum_verified===1&&e.jsxs("div",{className:"text-xs sm:text-sm text-green-600 dark:text-green-500 mt-1 flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 sm:w-4 sm:h-4 mr-1 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{children:"Checksum verified"})]})]}),u&&e.jsxs("div",{className:"mb-3 sm:mb-4 p-2 sm:p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg animate-fade-in",children:[e.jsxs("div",{className:"flex items-center text-red-700 dark:text-red-400 text-xs sm:text-sm",children:[e.jsx("svg",{className:"w-4 h-4 sm:w-5 sm:h-5 mr-2 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),e.jsx("span",{className:"font-medium",children:"Download Failed"})]}),t.error_message&&e.jsx("div",{className:"text-xs sm:text-sm text-red-600 dark:text-red-500 mt-1 break-all",children:t.error_message})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[m&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>f(t.id),className:"btn btn-secondary text-xs sm:text-sm flex-1 sm:flex-initial transition-transform hover:scale-105",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}),"Pause"]}),e.jsxs("button",{onClick:()=>g(t.id),className:"btn btn-danger text-xs sm:text-sm flex-1 sm:flex-initial transition-transform hover:scale-105",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),"Cancel"]})]}),x&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>o(t.id),className:"btn btn-primary text-xs sm:text-sm flex-1 sm:flex-initial transition-transform hover:scale-105",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"})}),"Resume"]}),e.jsxs("button",{onClick:()=>g(t.id),className:"btn btn-danger text-xs sm:text-sm flex-1 sm:flex-initial transition-transform hover:scale-105",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),"Cancel"]})]}),(i||u||p)&&e.jsxs("button",{onClick:()=>h(t.id),className:"btn btn-secondary text-xs sm:text-sm transition-transform hover:scale-105",children:[e.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}),"Dismiss"]})]})]})}export{R as default};
